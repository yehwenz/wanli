import{R as he,S as xe,Q as ue,P as O,T as we,U as ke,W as Ve,X as Ce,d as Ue,u as Se,a as $e,r as o,o as Be,Y as ae,Z as ze,j as te,G as h,B as Ie,f as M,w as t,g as i,h as C,l as a,m as k,t as $,V as Te,k as y,x as le,z as N,$ as oe,n as ne,a0 as Ae,A as se,a1 as Ee,I as je,J as Me,_ as Ge}from"./index-DkzAPJNB.js";function Re(f,c){return c===void 0&&(c=xe),he(f,f,c)}function De(f){return ue(function(c,_){var s=!1,g=null,n=null,m=function(){if(n==null||n.unsubscribe(),n=null,s){s=!1;var p=g;g=null,_.next(p)}};c.subscribe(O(_,function(p){n==null||n.unsubscribe(),s=!0,g=p,n=O(_,m,we),ke(f(p)).subscribe(n)},function(){m(),_.complete()},void 0,function(){g=n=null}))})}function Fe(f,c,_){var s=Ce(f)||c||_?{next:f,error:c,complete:_}:f;return s?ue(function(g,n){var m;(m=s.subscribe)===null||m===void 0||m.call(s);var p=!0;g.subscribe(O(n,function(u){var d;(d=s.next)===null||d===void 0||d.call(s,u),n.next(u)},function(){var u;p=!1,(u=s.complete)===null||u===void 0||u.call(s),n.complete()},function(u){var d;p=!1,(d=s.error)===null||d===void 0||d.call(s,u),n.error(u)},function(){var u,d;p&&((u=s.unsubscribe)===null||u===void 0||u.call(s)),(d=s.finalize)===null||d===void 0||d.call(s)}))}):Ve}const ie=f=>(je("data-v-b9050894"),f=f(),Me(),f),Le=ie(()=>y("br",null,null,-1)),Pe={style:{color:"#C62828"}},Ne={style:{"font-size":"medium"}},Oe={key:0},Qe={key:1},He={class:"d-flex justify-center w-100 pa-10"},Je=ie(()=>y("span",null,"請輸入驗證碼",-1)),We=[Je],Xe={class:"d-flex justify-center text-subtitle-1"},Ye={style:{color:"red"}},Ze=Ue({__name:"CustomerIndex",setup(f){const{axiosIns:c}=Se(),{setToken:_,setRole:s,setGoogle:g}=$e(),n=o(1),m=o(),p=o(!1),u=o("elevated"),d=o("blue"),re=o({theme:"filled_blue",text:"signin_with",size:"large",shape:"pill",state:"GBtn"}),B=o(!1),z=o(!1),G=o(""),R=o(""),b=o(!1),Q=o(),H=o(""),D=o(""),F=o(""),J=o(""),V=o(),I=o(),T=o(!1),A=o(""),x=o(),U=o(),E=o(!1),S=o(),W=o(!1);Be(()=>{var l;(l=m.value)!=null&&l.$el&&ae(m.value.$el,"click").pipe(Fe(()=>b.value=!0),De(()=>Re(500))).subscribe(()=>X()),n.value==1&&ae(document,"keydown").pipe(ze(e=>e.key==="Enter")).subscribe(()=>X())});const ce=async l=>{await c.get("api/Totp",{headers:{Authorization:`Bearer ${l}`}}).then(e=>{if(e.data.secret==""&&e.data.authUrl=="")z.value=!0;else return J.value=e.data.secret,c.post("api/QrCode",{url:e.data.authUrl},{responseType:"blob",headers:{Authorization:`Bearer ${l}`}})}).then(e=>{e&&(z.value=!0,D.value=URL.createObjectURL(e.data))}).catch(e=>{b.value=!1,e.response?(x.value=!0,U.value=e.response.data):(x.value=!0,U.value="系統異常，請告知開發人員")})},de=async l=>{g(l.credential),await c.post("api/Sign/google",{token:l.credential}).then(e=>{H.value=e.data,ce(e.data)}).catch(e=>{e.response?(x.value=!0,U.value=e.response.data):(x.value=!0,U.value="系統異常，請告知開發人員")})},X=async()=>{var e;const l=await((e=Q.value)==null?void 0:e.validate());b.value=!0,l!=null&&l.valid?await c.post("api/Sign",{userid:G.value,password:R.value}).then(v=>{_(v.data);const w=te(v.data)["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];switch(s(w),b.value=!1,p.value=!0,u.value="outlined",d.value="green",V.value=null,I.value=null,w){case"U":h.replace({name:"Customer"});break;case"A":h.replace({name:"UserManagement"});break;case"C":h.replace({name:"counselor"});break;case"P":h.replace({name:"coordinator"});break}}).catch(v=>{b.value=!1,v.response?(V.value=!0,I.value=v.response.data):(V.value=!0,I.value="系統異常，請告知開發人員")}):b.value=!1},ve=l=>{E.value=!0,fe(l)},fe=async l=>{await c.post("api/Totp/VerifyBySecret",{secret:J.value,code:l},{headers:{Authorization:`Bearer ${H.value}`}}).then(e=>{b.value=!1,T.value=!1,A.value="",E.value=!1,W.value=!0,_(e.data);const v=te(e.data)["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];switch(s(v),v){case"U":h.replace({name:"Customer"});break;case"A":h.replace({name:"UserManagement"});break;case"C":h.replace({name:"counselor"});break;case"P":h.replace({name:"coordinator"});break}}).catch(e=>{var v,w;b.value=!1,E.value=!1,e.response?((v=S.value)==null||v.reset(),(w=S.value)==null||w.focus(),T.value=!0,A.value=e.response.data):(T.value=!0,A.value="系統異常，請告知開發人員")})};return Ie(()=>F.value,l=>{l.length==6&&ve(l)}),(l,e)=>{const v=i("v-tab"),w=i("v-tabs"),pe=i("v-alert"),_e=i("v-slide-y-transition"),Y=i("v-text-field"),j=i("v-col"),L=i("v-icon"),Z=i("v-row"),q=i("v-tabs-window-item"),me=i("v-tabs-window"),K=i("v-card-text"),P=i("v-card"),be=i("v-card-title"),ye=i("v-img"),ee=i("v-dialog"),ge=i("v-container");return C(),M(ge,{class:"d-flex justify-center align-center",style:{height:"85vh"}},{default:t(()=>[a(P,{"max-width":"400px",width:"400px"},{default:t(()=>[a(w,{modelValue:n.value,"onUpdate:modelValue":e[0]||(e[0]=r=>n.value=r),"bg-color":"blue"},{default:t(()=>[a(v,{value:1,fixed:""},{default:t(()=>[k("教職員登入")]),_:1}),a(v,{value:2,fixed:""},{default:t(()=>[k("Google登入")]),_:1})]),_:1},8,["modelValue"]),a(K,null,{default:t(()=>[a(_e,null,{default:t(()=>[a(pe,{class:"mb-3",type:"warning",title:"提示",closable:""},{default:t(()=>[k(" 教職員登入是不能用google帳號登入的"),Le,k(" 必須是學校帳號才可以使用教職員登入! ")]),_:1})]),_:1}),a(me,{modelValue:n.value,"onUpdate:modelValue":e[4]||(e[4]=r=>n.value=r)},{default:t(()=>[a(q,{value:1},{default:t(()=>[a($(Te),{ref_key:"form",ref:Q},{default:t(()=>[a(Z,null,{default:t(()=>[a(j,{cols:"12"},{default:t(()=>[a(Y,{label:"帳號",modelValue:G.value,"onUpdate:modelValue":e[1]||(e[1]=r=>G.value=r),"prepend-inner-icon":"mdi-account",error:V.value},null,8,["modelValue","error"])]),_:1}),a(j,{cols:"12"},{default:t(()=>[a(Y,{label:"密碼",modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=r=>R.value=r),"prepend-inner-icon":"mdi-lock",type:B.value?"text":"password","append-inner-icon":B.value?"mdi-eye-off":"mdi-eye","onClick:appendInner":e[3]||(e[3]=()=>B.value=!B.value),error:V.value},null,8,["modelValue","type","append-inner-icon","error"])]),_:1}),V.value?(C(),M(j,{key:0,cols:"12"},{default:t(()=>[y("div",Pe,[a(L,null,{default:t(()=>[k("mdi-alert")]),_:1}),y("span",Ne,le(I.value),1)])]),_:1})):N("",!0)]),_:1}),a(Z,null,{default:t(()=>[a(j,{cols:"12"},{default:t(()=>[a($(oe),{ref_key:"btn",ref:m,class:"font-weight-bold",color:d.value,variant:u.value,loading:b.value,disabled:b.value,block:""},{default:t(()=>[p.value?(C(),ne("span",Oe,[a(L,{color:"green",class:"text-h5"},{default:t(()=>[k("mdi-check-circle")]),_:1})])):(C(),ne("span",Qe,"登入"))]),_:1},8,["color","variant","loading","disabled"])]),_:1})]),_:1})]),_:1},512)]),_:1}),a(q,{value:2},{default:t(()=>[y("div",He,[a($(Ae),{callback:de,"button-config":re.value,"id-configuration":{use_fedcm_for_prompt:!0}},null,8,["button-config"])])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(ee,{"max-width":"450",modelValue:z.value,"onUpdate:modelValue":e[6]||(e[6]=r=>z.value=r),persistent:"",onAfterEnter:e[7]||(e[7]=r=>l.$nextTick(()=>S.value&&S.value.focus()))},{default:t(()=>[a(P,null,{default:t(()=>[a(be,null,{default:t(()=>[y("span",{style:se([{"font-weight":"bold"},{fontSize:l.$vuetify.display.xs?"20px":"25px"}])},"安全性驗證:",4)]),_:1}),a(K,null,{default:t(()=>[y("div",{class:"d-flex justify-center",style:se({fontSize:l.$vuetify.display.xs?"17px":"20px"})},We,4),a($(Ee),{ref_key:"otpinput",ref:S,modelValue:F.value,"onUpdate:modelValue":e[5]||(e[5]=r=>F.value=r),focused:"",loading:E.value,error:T.value,height:l.$vuetify.display.xs?"60px":"",width:l.$vuetify.display.xs?"300px":""},null,8,["modelValue","loading","error","height","width"]),y("div",Xe,[W.value?(C(),M(L,{key:0,color:"green"},{default:t(()=>[k("mdi-check-circle")]),_:1})):N("",!0),y("span",Ye,le(A.value),1)]),D.value?(C(),M(ye,{key:0,src:D.value,height:"200"},null,8,["src"])):N("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ee,{modelValue:x.value,"onUpdate:modelValue":e[9]||(e[9]=r=>x.value=r),"max-width":"400px",persistent:""},{default:t(()=>[a(P,{"prepend-icon":"mdi-alert-circle",color:"warning",title:"登入失敗",text:U.value},{actions:t(()=>[a($(oe),{text:"ok",onClick:e[8]||(e[8]=r=>x.value=!1),variant:"flat"})]),_:1},8,["text"])]),_:1},8,["modelValue"])]),_:1})}}}),Ke=Ge(Ze,[["__scopeId","data-v-b9050894"]]);export{Ke as default};
